<tmpl_include header.tmpl>

<script type="text/javascript">

Krang.onload( function() {
  Krang.Nav.edit_mode();
  Krang.Help.set( 'story_new' );
} );

create = function()
{
  Krang.Form.submit( 'new_story', { rm: 'create' } );
}

cancel = function()
{
  Krang.Form.submit( 'new_story', { rm: 'cancel' } );
}


// begin slug-generation javascript

<tmpl_loop title_to_slug_function_loop>
<tmpl_var type>_title_to_slug = <tmpl_var function>
</tmpl_loop>

var auto_build_slug = 1;
build_slug = function(title)
{ 
 if (title && auto_build_slug) {	
   var slug_function = document.new_story.type.value + '_title_to_slug';
   if (eval('typeof ' + slug_function) == 'function') {
     // this story type has a class-overridden conversion function
     document.new_story.slug.value = eval(slug_function + "('" + title + "')"); 
   } else {
     // this story type needs the default conversion function
     document.new_story.slug.value = Krang.Slug.title_to_slug(title); 
   }
 }
}

hide_or_show_slug = function() {

  // figure out if the current story type is a cover type
  var is_cover_type = 0;
  <tmpl_loop cover_types_loop>
  if (document.new_story.type.value == '<tmpl_var cover_type>') { is_cover_type = 1; }	
  </tmpl_loop>

  // if it is and we're not yet hiding the slug...
  var hiding_slug = (document.getElementById("slug_row").style.display == 'none');
  if (is_cover_type && !hiding_slug) {
    document.new_story.slug.value = '';
    document.getElementById("slug_row").style.display = 'none';
    auto_build_slug = 0;

  // if it isn't...
  } else if (!is_cover_type) {
    if (hiding_slug) { 
       auto_build_slug = 1; // default to auto-build if slug was previously hidden
    };
    build_slug(document.new_story.title.value);    
    document.getElementById("slug_row").style.display = '';
  }
}

// end slug-generation javascript

</script>




<h2>
New Story
</h2>

<form name="new_story" method="post" action="story.pl">

<input name="rm" type="hidden">

<table class="request" summary="">

<colgroup>
<col class="c-label">
<col>
</colgroup>

<tbody class="demi">

<tr<tmpl_if bad_type> class="err"</tmpl_if>>
<th>*Type</th>
<td><tmpl_var type_selector></td>
</tr>

<tr<tmpl_if bad_title> class="err"</tmpl_if>>
<th>*Title</th>
<td><input name="title" value="<tmpl_var escape=html title>" onkeyup="build_slug(this.value)"></td>
</tr>

<tr id="slug_row"<tmpl_if bad_slug> class="err"</tmpl_if>>
<th>Slug</th>
<td><input name="slug" value="<tmpl_var escape=html slug>" onkeyup="auto_build_slug=0"></td>
</tr>

</tbody>

<tbody>

<tr<tmpl_if bad_cover_date> class="err"</tmpl_if>>
<th>*Cover Date</th>
<td><tmpl_var cover_date_selector></td>
</tr>

<tr<tmpl_if bad_category_id> class="err"</tmpl_if>>
<th>*Site/Category</th>
<td><tmpl_var category_chooser></td>
</tr>

</tbody>

</table>

<div class="panel capped">
<input value="Cancel" onclick="cancel()" type="button" class="west">
<input value="Create" onclick="create()" type="button">
</div>

</form>

<tmpl_include footer.tmpl>

