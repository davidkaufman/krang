<script type="text/javascript">
//(mp) We reference the 'edit' form throughout. This isn't
// the most ideal since we're forcing the parent template
// to name their form a certain way, but it will work for the
// time being

<tmpl_if crumbs>
  jump_to = function( p )  //:cf. edit_children(db2)
  {
    Krang.form_submit('edit', { rm: 'save_and_jump', jump_to: p });
  }
</tmpl_if>

<tmpl_if bulk_edit>

  save_and_change_bulk_edit_sep = function()
  {
    Krang.form_submit('edit', { rm: 'save_and_change_bulk_edit_sep' });
  }

  update_bulk_edit_counts = function()
  {
    var words_span = document.getElementById( 'bulk_edit_words' );
    var chars_span = document.getElementById( 'bulk_edit_chars' );
    var text       = document.forms[ 0 ].bulk_data.value;
    var words      = text.split( /\s+/ );
    var word_count = 0;
    var char_count = 0;
    var re = /\S/;

    for( var i = 0; i < words.length; i++ )
    {
      if ( re.test( words[ i ] ) && words[ i ] != '<tmpl_var escape=js bulk_edit_sep>' )
      {
        word_count++;
        char_count += words[ i ].length;
      }
    }

    words_span.innerHTML = word_count;
    chars_span.innerHTML = char_count;

    setTimeout( update_bulk_edit_counts, 1000 + ( text.length / 10 ) );
  }

<tmpl_else>

  find_media = function( p )
  {
    Krang.form_submit('edit', { rm: 'save_and_find_media_link', jump_to: p });
  }

  find_story = function( p )
  {
    Krang.form_submit('edit', { rm: 'save_and_find_story_link', jump_to: p });
  }

  save_and_add = function()
  {
    Krang.form_submit('edit', { rm: 'save_and_add' });
  }

  save_and_jump = function()
  {
    Krang.form_submit('edit', { rm: 'save_and_jump' });
  }

  edit_children = function( p )
  {
    Krang.form_submit('edit', { rm: 'save_and_jump', jump_to: p });
  }

  <tmpl_if bulk_edit_select>
    save_and_bulk_edit = function()
    {
      Krang.form_submit('edit', { rm: 'save_and_bulk_edit' });
    }
  </tmpl_if>

  remove_children = function()
  {
    if ( confirm( 'Are you SURE you want to delete these sub-elements?' ) )
      Krang.form_submit('edit', { rm: 'delete_children' }, { to_top: false });
  }

  <tmpl_if child_select>
    var containers = new Array();

    <tmpl_loop container_loop>
      containers[ '<tmpl_var escape=js name>' ] = 1;
    </tmpl_loop>

    add_child = function()
    {
      var f    = document.forms[ 'edit' ];
      var list = f.elements[ 'child' ];
      var name = list.options[ list.selectedIndex ].value;

      Krang.form_submit( 'edit', { rm: ( containers[ name ] ? 'save_and_add' : 'add' ) }, { to_top: false });
    }
  </tmpl_if>

  <tmpl_unless no_reorder>
    reorder = function()
    {
      Krang.form_submit('edit', { rm: 'reorder' }, { to_top: false });
    }
  </tmpl_unless>

</tmpl_if>
</script>

<input name="path" value="<tmpl_var escape=html path>" type="hidden">
<input name="jump_to" type="hidden">
<input name="bulk_edit" value="<tmpl_var escape=html bulk_edit>" type="hidden">
<tmpl_if bulk_edit>
  <input name="bulk_edit_child" value="<tmpl_var escape=html bulk_edit_child>" type="hidden">
  <input name="bulk_edit_sep" value="<tmpl_var escape=html bulk_edit_sep>" type="hidden">
</tmpl_if>

<tmpl_if alert><ul class="notes"><li>
  <tmpl_var escape=html alert>
</li></ul></tmpl_if>

<tmpl_if crumbs><div class="east">(<tmpl_loop crumbs>
  <tmpl_unless __last__><a href="javascript:jump_to('<tmpl_var escape=html path>')"></tmpl_unless><tmpl_var escape=html name><tmpl_unless __last__></a> &raquo;</tmpl_unless>
</tmpl_loop>)</div></tmpl_if>

<h3><tmpl_if bulk_edit>
  Bulk Edit
<tmpl_else>
  Content
</tmpl_if></h3>

<tmpl_if bulk_edit>

  <table summary="">

  <colgroup>
  <col class="c-label">
  <col>
  </colgroup>

  <tr class="meld">
  <td colspan="2" class="full">
  <textarea name="bulk_data" rows="20" cols="60"><tmpl_var escape=html bulk_data></textarea>
  </td>
  </tr>

  <tr>
  <th>Separator String</th>
  <td>
  <tmpl_var bulk_edit_sep_selector><!--:markup-->
  <input value="Change Separator" onclick="save_and_change_bulk_edit_sep()" type="button" class="button">
  </td>
  </tr>

  <tr>
  <th>Word Count</th>
  <td id="bulk_edit_words"></td>
  </tr>

  <tr class="last">
  <th>Character Count</th>
  <td id="bulk_edit_chars"></td>
  </tr>

  </table>

  <script type="text/javascript">
  setTimeout( update_bulk_edit_counts, 1000 );  //:should trigger onload(db2)
  </script>

<tmpl_else><tmpl_unless child_loop>

  <p>
  No sub-elements defined.
  </p>

  <tmpl_if child_select>
    <p>
    <tmpl_var child_select><!--:markup-->
    <input value="Add Element" onclick="add_child()" type="button" class="button">
    </p>
  </tmpl_if>

  <tmpl_if bulk_edit_select>
    <p>
    <tmpl_var bulk_edit_select><!--:markup-->
    <input value="Bulk Edit" onclick="save_and_bulk_edit()" type="button" class="button">
    </p>
  </tmpl_if>

<tmpl_else>

  <table class="list edit select_row" summary=""><!--:FIX(db2)-->

  <colgroup>
  <col class="series">
  <col class="c-mini">
  <col>
  <col class="series">
  </colgroup>

  <thead>
  <tr>
  <th class="series">Order</th>
  <th>Element</th>
  <th>Data Entry</th>
  <th class="series"><tmpl_unless no_reorder><input onclick="Krang.check_all(this,'remove_')" type="checkbox"><tmpl_else><!-- --></tmpl_unless></th>
  </tr>
  </thead>

  <tbody>

  <tmpl_loop child_loop>
    <tr>
    <td class="series"><tmpl_var order_select><!--:markup--></td>

    <th class="wrap"><tmpl_if required>*</tmpl_if><tmpl_var escape=html name></th>

    <td>
    <tmpl_if is_container>
      <input value="Edit" onclick="edit_children('<tmpl_var escape=html path>')" type="button" class="button">
    </tmpl_if>
    <tmpl_var form><!--:markup-->
    </td>

    <td class="series"><tmpl_if allow_delete><input name="remove_<tmpl_var escape=html index>" type="checkbox"><tmpl_else><!-- --></tmpl_if></td>
    </tr>
  </tmpl_loop>

  <tr>
  <td class="series"><tmpl_unless no_reorder><input value="Reorder" onclick="reorder()" type="button" class="button"><tmpl_else><!-- --></tmpl_unless></td>

  <td><!-- --></td>

  <td><!--(db2)TODO - constrain form control widths:-->
  <tmpl_if child_select>
    <tmpl_var child_select><!--:markup-->
    <input value="Add Element" onclick="add_child()" type="button" class="button">
  </tmpl_if>

  <tmpl_if bulk_edit_select>
    <tmpl_var bulk_edit_select><!--:markup-->
    <input value="Bulk Edit" onclick="save_and_bulk_edit()" type="button" class="button">
  </tmpl_if>
  </td>

  <td class="series"><tmpl_unless no_delete><input value="Delete" onclick="remove_children()" type="button" class="button"><tmpl_else><!-- --></tmpl_unless></td>
  </tr>

  </tbody>

  </table>

</tmpl_unless></tmpl_if>

