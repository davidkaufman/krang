<tmpl_include header.tmpl>

<script type="text/javascript">
Krang.onload( function() {
  Krang.Nav.edit_mode();
  Krang.Help.set( 'template_<tmpl_if add_mode>new<tmpl_else>find</tmpl_if>' );
} );

do_save_stay = function()
{
  Krang.form_submit( 'edit_template_form', { rm: '<tmpl_if add_mode>add<tmpl_else>edit</tmpl_if>_save_stay' }, { to_top: false });
}

do_save = function()
{
  Krang.form_submit( 'edit_template_form', { rm: '<tmpl_if add_mode>add<tmpl_else>edit</tmpl_if>_save' });
}

//(db2)untied to UI; runmodes exist:
//do_checkin = function()
//{
//  Krang.form_submit( 'edit_template_form', { rm: '<tmpl_if add_mode>add<tmpl_else>edit</tmpl_if>_checkin' });
//}
//
//do_cancel = function()
//{
//  Krang.form_submit( 'edit_template_form', { rm: '<tmpl_if add_mode>add<tmpl_else>edit</tmpl_if>_cancel' });
//}

do_deploy = function()
{
  Krang.form_submit('edit_template_form', { rm: 'deploy' });
}

save_and_view_log = function()
{
  Krang.form_submit('edit_template_form', { rm: 'save_and_view_log' });
}

<tmpl_if add_mode>
  update_filename = function( el )
  {
    var isNil  = ( el.value == '' );
    var elFile = el.form[ 'filename' ];

    elFile.value                 = isNil ? ''     : el.value + '.tmpl';
    elFile.style.backgroundColor = isNil ? '#FFF' : '#DDD';
    elFile.readOnly              = !isNil;
  }
<tmpl_else>
  revert_version = function()
  {
    if ( confirm( 'Are you SURE you want to discard your work and revert to this old version?' ) )
      Krang.form_submit('edit_template_form', { rm: 'revert_version' });
  }

  view_version = function()
  {
    Krang.form_submit('edit_template_form', { rm: 'view_version' });
  }

  do_delete = function()
  {
    if ( confirm( 'Are you SURE you want to delete this Template?' ) )
      Krang.form_submit( 'delete_template_form'<tmpl_if add_mode>, { rm: 'cancel_add' }</tmpl_if> );
  }
</tmpl_if>
</script>

<tmpl_unless add_mode><p class="east">
  <a href="javascript:save_and_view_log()">View Log</a>
</p></tmpl_unless>

<h2>
<tmpl_if add_mode>
  New
<tmpl_else>
  Edit
</tmpl_if>
Template
</h2>

<form name="edit_template_form" method="post" enctype="multipart/form-data" action="template.pl">

<input name="rm" value="<tmpl_if add_mode>add<tmpl_else>edit</tmpl_if>_save" type="hidden">
<input name="template_id" value="<tmpl_var escape=html template_id>" type="hidden">
<tmpl_unless add_mode>
  <tmpl_var history_return_params>
</tmpl_unless>

<tmpl_unless add_mode>

  <h3>
  Properties
  </h3>

  <table summary="">

  <colgroup>
  <col class="c-label">
  <col>
  </colgroup>

  <tr>
  <th>Template ID</th>
  <td><tmpl_var escape=html template_id></td>
  </tr>

  <tr>
  <th>Filename</th>
  <td><tmpl_var escape=html filename></td>
  </tr>

  <tr>
  <th>URL</th>
  <td><tmpl_var escape=html url></td>
  </tr>

  <tr>
  <th>Current Version</th>
  <td><tmpl_var escape=html version></td>
  </tr>

  <tr class="last">
  <th>Deployed Version</th>
  <td><tmpl_unless deployed_version>[n/a]<tmpl_else><tmpl_var escape=html deployed_version></tmpl_unless></td>
  </tr>

  </table>

</tmpl_unless>

<table summary="">

<colgroup>
<col class="c-label">
<col>
</colgroup>

<tmpl_if add_mode>
  <tr<tmpl_if error_no_filename> class="ERR-ROW"<tmpl_else><tmpl_if duplicate_url> class="ERR-ROW"<tmpl_else><tmpl_if error_element> class="ERR-ROW"</tmpl_if></tmpl_if></tmpl_if>>
  <th>Element</th>
  <td><tmpl_var element_chooser></td>
  </tr>

  <tr<tmpl_if error_invalid_filename> class="ERR-ROW"<tmpl_else><tmpl_if error_no_filename> class="ERR-ROW"</tmpl_if></tmpl_if>>
  <th>Filename</th>
  <td class="demi"><input name="filename" value="<tmpl_var escape=html filename>"<tmpl_if duplicate_url> readonly</tmpl_if>></td>
  </tr>

  <tr<tmpl_if duplicate_url> class="ERR-ROW"<tmpl_else><tmpl_if error_category_id> class="ERR-ROW"</tmpl_if></tmpl_if>>
  <th>Site/Category</th>
  <td><tmpl_var category_chooser></td>
  </tr>
</tmpl_if>

<tr<tmpl_if error_template_file> class="ERR-ROW"<tmpl_else><tmpl_if duplicate_url> class="ERR-ROW"</tmpl_if></tmpl_if>><!--db2: uncertain abt. duplicate_url here-->
<th>Upload Template File</th>
<td>
<tmpl_if filename>
  Current File
  <tmpl_var escape=html filename>
  <tmpl_if file_size>(<tmpl_var escape=html file_size>)</tmpl_if>
  <i>&mdash; or &mdash;</i>
  <br>
</tmpl_if>
<tmpl_var upload_chooser>
</td>
</tr>

<tr>
<td colspan="2" class="full"><textarea name="content" rows="30" cols="60"><tmpl_var escape=html content></textarea></td>
</tr>

<tr class="last">
<th>Test with Template</th>
<td><input name="testing" value="1" type="checkbox"<tmpl_if testing> checked</tmpl_if>> Yes</td>  <!-- db2: should be radio inputs? -->
</tr>

</table>

<tmpl_unless add_mode>
  <p>
  Version
  <tmpl_var version_chooser>
  <input value="Revert" onclick="revert_version()" type="button" class="button">
  <input value="View" onclick="view_version()" type="button" class="button">
  </p>
</tmpl_unless>

<div class="panel">
<input value="Save &amp; Stay" onclick="do_save_stay()" type="button">
<input value="Save" onclick="do_save()" type="button">
<input value="Deploy" onclick="do_deploy()" type="button">
<tmpl_unless add_mode>
  <input value="Delete" onclick="do_delete()" type="button">
</tmpl_unless>
</div>

</form>

<tmpl_unless add_mode>
  <form name="delete_template_form" method="post" action="template.pl">
  <input name="rm" value="delete" type="hidden">
  <input name="template_id" value="<tmpl_var escape=html template_id>" type="hidden">
  </form>
</tmpl_unless>

<tmpl_include footer.tmpl>

